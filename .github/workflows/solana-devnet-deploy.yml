name: solana-devnet-deploy

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      SOLANA_URL: https://api.devnet.solana.com
      PROGRAM_KEYPAIR_PATH: gadgetguard-solana/target/deploy/gadgetguard-keypair.json
      ANCHOR_WALLET: /home/runner/.config/solana/id.json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Remove incompatible Cargo.lock (if present)
        shell: bash
        run: |
          set -euo pipefail
          rm -f gadgetguard-solana/Cargo.lock
          test ! -f gadgetguard-solana/Cargo.lock

      - name: Setup Anchor + Solana
        uses: metadaoproject/setup-anchor@v3.4
        with:
          anchor-version: "0.30.1"
          solana-cli-version: "1.18.18"
          node-version: "20.16.0"

      - name: Pin Rust toolchain (edition2024-compatible)
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.85.0 --profile minimal
          rustup default 1.85.0
          rustc --version
          cargo --version

      - name: Write keypairs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.config/solana"
          cat > "$HOME/.config/solana/id.json" <<'EOF'
          ${{ secrets.DEPLOYER_KEYPAIR_JSON }}
          EOF
          chmod 600 "$HOME/.config/solana/id.json"

          mkdir -p "$(dirname "${PROGRAM_KEYPAIR_PATH}")"
          cat > "${PROGRAM_KEYPAIR_PATH}" <<'EOF'
          ${{ secrets.PROGRAM_KEYPAIR_JSON }}
          EOF
          chmod 600 "${PROGRAM_KEYPAIR_PATH}"

      - name: Configure Solana
        shell: bash
        run: |
          set -euo pipefail
          solana config set --url "$SOLANA_URL"
          solana config set --keypair "$ANCHOR_WALLET"
          solana config get

      - name: Sync program ID from keypair
        shell: bash
        run: |
          set -euo pipefail
          PROGRAM_ID=$(solana-keygen pubkey "$PROGRAM_KEYPAIR_PATH")
          export PROGRAM_ID
          echo "Program ID: $PROGRAM_ID"
          python3 - <<'PY'
          import pathlib
          import re
          import os

          program_id = os.environ["PROGRAM_ID"]

          anchor_toml = pathlib.Path("gadgetguard-solana/Anchor.toml")
          content = anchor_toml.read_text(encoding="utf-8")
          content = re.sub(r'(?m)^gadgetguard\s*=\s*"[^"]+"', f'gadgetguard = "{program_id}"', content)
          anchor_toml.write_text(content, encoding="utf-8")

          lib_rs = pathlib.Path("gadgetguard-solana/programs/gadgetguard/src/lib.rs")
          lib_content = lib_rs.read_text(encoding="utf-8")
          lib_content = re.sub(r'declare_id!\("[^"]+"\);', f'declare_id!("{program_id}");', lib_content)
          lib_rs.write_text(lib_content, encoding="utf-8")
          PY

      - name: Airdrop with retries
        shell: bash
        run: |
          set -euo pipefail
          for attempt in 1 2 3 4 5; do
            echo "Airdrop attempt $attempt/5"
            if solana airdrop 2 --url "$SOLANA_URL"; then
              break
            fi
            sleep 10
          done
          solana balance --url "$SOLANA_URL"

      - name: Build program
        shell: bash
        run: |
          set -euo pipefail
          cd gadgetguard-solana
          echo "Pre-build lockfile cleanup"
          find . -name Cargo.lock -print -delete || true
          test ! -f Cargo.lock
          ls -la
          anchor build

      - name: Deploy program
        shell: bash
        run: |
          set -euo pipefail
          cd gadgetguard-solana
          anchor deploy --provider.cluster devnet --provider.wallet "$ANCHOR_WALLET"

      - name: Print Program ID and IDL path
        shell: bash
        run: |
          set -euo pipefail
          PROGRAM_ID=$(solana-keygen pubkey "$PROGRAM_KEYPAIR_PATH")
          echo "Deployed Program ID: $PROGRAM_ID"
          echo "IDL path: gadgetguard-solana/target/idl/gadgetguard.json"

      - name: Upload IDL artifact
        uses: actions/upload-artifact@v4
        with:
          name: gadgetguard-idl
          path: gadgetguard-solana/target/idl/gadgetguard.json
